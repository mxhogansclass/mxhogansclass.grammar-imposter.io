<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grammar Impostor</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0e0e12; --surface: #17171d; --card: #1f1f28; --border: #2c2c3a;
  --red: #ff3b5c; --red-dim: rgba(255,59,92,0.15);
  --green: #00e5a0; --green-dim: rgba(0,229,160,0.12);
  --yellow: #ffd166; --yellow-dim: rgba(255,209,102,0.12);
  --blue: #4ea8ff; --text: #eeeef5; --muted: #6b6b80;
  --radius: 14px; --font-display: 'Bebas Neue', sans-serif; --font-body: 'DM Sans', sans-serif;
}
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font-body); font-size: 16px; -webkit-tap-highlight-color: transparent; }
body::before { content:''; position:fixed; inset:0; opacity:0.04; pointer-events:none; z-index:0;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 39px, var(--border) 39px, var(--border) 40px),
                    repeating-linear-gradient(90deg, transparent, transparent 39px, var(--border) 39px, var(--border) 40px); }
.app { position:relative; z-index:1; min-height:100vh; display:flex; flex-direction:column; max-width:520px; margin:0 auto; padding:0 16px 60px; }
.screen { display:none; flex-direction:column; gap:16px; padding-top:32px; animation:fadeUp 0.3s ease; }
.screen.active { display:flex; }
@keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.logo { font-family:var(--font-display); font-size:clamp(2.8rem,12vw,4.2rem); letter-spacing:0.04em; line-height:1; }
.logo span { color:var(--red); }
.eyebrow { font-size:11px; letter-spacing:0.18em; text-transform:uppercase; color:var(--muted); font-weight:600; }
h2 { font-family:var(--font-display); font-size:2rem; letter-spacing:0.04em; line-height:1.1; }
p { line-height:1.6; color:var(--muted); font-size:14px; }
p strong { color:var(--text); }
.card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; }
.card.green  { border-color:var(--green);  background:var(--green-dim); }
.card.yellow { border-color:var(--yellow); background:var(--yellow-dim); }
.card.red    { border-color:var(--red);    background:var(--red-dim); }
input[type="text"], textarea { width:100%; background:var(--surface); border:1.5px solid var(--border); border-radius:10px; padding:13px 16px; color:var(--text); font-family:var(--font-body); font-size:15px; outline:none; transition:border-color 0.2s; -webkit-appearance:none; }
input[type="text"]:focus, textarea:focus { border-color:var(--green); }
input::placeholder, textarea::placeholder { color:var(--muted); }
textarea { resize:none; min-height:90px; line-height:1.6; }
label { font-size:12px; font-weight:600; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); display:block; margin-bottom:6px; }
.btn { display:block; width:100%; padding:15px 20px; border:none; border-radius:10px; font-family:var(--font-display); font-size:1.3rem; letter-spacing:0.06em; cursor:pointer; transition:transform 0.15s,box-shadow 0.15s; text-align:center; }
.btn:active { transform:scale(0.97); }
.btn-primary { background:var(--green); color:#0a0a0e; }
.btn-primary:hover { box-shadow:0 6px 24px rgba(0,229,160,0.3); }
.btn-danger  { background:var(--red); color:#fff; }
.btn-danger:hover { box-shadow:0 6px 24px rgba(255,59,92,0.3); }
.btn-ghost   { background:var(--card); color:var(--text); border:1px solid var(--border); }
.btn-ghost:hover { border-color:var(--muted); }
.btn:disabled { opacity:0.35; pointer-events:none; }
.btn-sm { font-size:1rem; padding:11px 16px; }
.row { display:flex; gap:10px; }
.row .btn { flex:1; }
.pill { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; }
.pill-green  { background:var(--green-dim);  color:var(--green);  border:1px solid var(--green); }
.pill-yellow { background:var(--yellow-dim); color:var(--yellow); border:1px solid var(--yellow); }
.pill-muted  { background:var(--surface);    color:var(--muted);  border:1px solid var(--border); }
.room-code-display { text-align:center; padding:24px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); }
.room-code-big { font-family:var(--font-display); font-size:clamp(3.5rem,16vw,5.5rem); letter-spacing:0.16em; color:var(--green); line-height:1; }
.room-code-label { font-size:11px; letter-spacing:0.14em; text-transform:uppercase; color:var(--muted); margin-bottom:8px; }
#qr-container { display:flex; justify-content:center; padding:16px; background:#fff; border-radius:12px; margin-top:12px; }
.player-list { display:flex; flex-direction:column; gap:8px; }
.player-item { display:flex; align-items:center; gap:12px; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:12px 14px; }
.player-avatar { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-family:var(--font-display); font-size:1.1rem; flex-shrink:0; }
.player-name-text { font-weight:600; font-size:15px; flex:1; }
.prompt-box { background:var(--card); border:1.5px solid var(--green); border-radius:var(--radius); padding:20px; }
.prompt-label { font-size:10px; letter-spacing:0.16em; text-transform:uppercase; color:var(--green); font-weight:700; margin-bottom:10px; }
.prompt-text { font-size:1.1rem; font-weight:600; line-height:1.5; color:var(--text); }
.imp-box { background:var(--card); border:1.5px solid var(--red); border-radius:var(--radius); padding:20px; text-align:center; }
.imp-label { font-size:10px; letter-spacing:0.16em; text-transform:uppercase; color:var(--red); font-weight:700; margin-bottom:10px; }
.imp-text { font-size:1rem; line-height:1.6; color:var(--muted); }
.sentence-display { background:var(--surface); border:2px solid var(--green); border-radius:var(--radius); padding:20px; }
.sentence-display-label { font-size:10px; letter-spacing:0.16em; text-transform:uppercase; color:var(--green); font-weight:700; margin-bottom:8px; }
.sentence-display-text { font-size:1.15rem; font-weight:600; line-height:1.5; color:var(--text); font-style:italic; }
.timer-ring { display:flex; flex-direction:column; align-items:center; padding:16px 0; }
.timer-svg { transform:rotate(-90deg); }
.timer-track { fill:none; stroke:var(--border); stroke-width:6; }
.timer-fill  { fill:none; stroke:var(--green); stroke-width:6; stroke-linecap:round; transition:stroke-dashoffset 1s linear, stroke 0.3s; }
.timer-number { font-family:var(--font-display); font-size:3.2rem; letter-spacing:0.04em; text-align:center; margin-top:-4px; color:var(--text); transition:color 0.3s; }
.timer-label  { font-size:11px; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); margin-top:4px; }
.ready-list { display:flex; flex-direction:column; gap:8px; }
.ready-item { display:flex; align-items:center; gap:12px; padding:12px 14px; background:var(--surface); border:1px solid var(--border); border-radius:10px; transition:all 0.25s; }
.ready-item.shared  { border-color:var(--green);  background:var(--green-dim); }
.ready-name { font-weight:600; font-size:14px; flex:1; }
.vote-grid { display:flex; flex-direction:column; gap:10px; }
.vote-card { display:flex; align-items:center; gap:12px; padding:14px 16px; background:var(--card); border:2px solid var(--border); border-radius:12px; cursor:pointer; transition:all 0.2s; }
.vote-card:hover:not(.no-vote) { border-color:var(--red); transform:translateX(4px); }
.vote-card.selected { border-color:var(--red); background:var(--red-dim); }
.vote-card.no-vote  { opacity:0.4; pointer-events:none; }
.vote-name { font-weight:600; font-size:15px; flex:1; }
.vote-badge { background:var(--red-dim); color:var(--red); border:1px solid var(--red); border-radius:20px; padding:2px 10px; font-size:12px; font-weight:700; display:none; }
.vote-badge.show { display:block; }
.progress-bar { height:3px; background:var(--border); border-radius:2px; overflow:hidden; }
.progress-fill { height:100%; background:var(--green); border-radius:2px; transition:width 0.4s ease; }
.lb-row { display:flex; align-items:center; gap:12px; padding:14px 16px; background:var(--surface); border:1px solid var(--border); border-radius:12px; margin-bottom:8px; }
.lb-row.first  { border-color:var(--yellow); background:var(--yellow-dim); transform:scale(1.03); }
.lb-row.second { border-color:var(--muted); }
.lb-row.third  { border-color:#cd7f32; background:rgba(205,127,50,0.08); }
.lb-rank { font-family:var(--font-display); font-size:1.4rem; width:36px; text-align:center; }
.lb-name { flex:1; font-weight:600; font-size:15px; }
.lb-score { font-family:var(--font-display); font-size:1.5rem; color:var(--yellow); }
.lb-delta { font-size:12px; color:var(--green); margin-left:6px; font-weight:700; }
.result-hero { text-align:center; padding:28px 20px; background:var(--card); border-radius:var(--radius); }
.result-emoji { font-size:56px; margin-bottom:10px; }
.result-title { font-family:var(--font-display); font-size:2.2rem; letter-spacing:0.04em; margin-bottom:6px; }
.result-sub   { font-size:14px; color:var(--muted); line-height:1.5; }
.reveal-item  { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:14px 16px; margin-bottom:8px; }
.reveal-item.imp { border-color:var(--red); background:var(--red-dim); }
.reveal-who   { font-size:11px; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); margin-bottom:4px; }
.reveal-who.imp { color:var(--red); }
.reveal-text  { font-weight:600; font-size:15px; line-height:1.4; }
.correct-box  { background:var(--green-dim); border:1px solid var(--green); border-radius:10px; padding:14px 16px; }
.correct-lbl  { font-size:11px; letter-spacing:0.1em; text-transform:uppercase; color:var(--green); margin-bottom:4px; }
.correct-text { font-weight:700; font-size:15px; }
.waiting { text-align:center; padding:24px 0; }
.spinner { width:32px; height:32px; border-radius:50%; border:3px solid var(--border); border-top-color:var(--green); animation:spin 0.8s linear infinite; margin:0 auto 14px; }
@keyframes spin { to{transform:rotate(360deg)} }
.gap-sm { display:flex; flex-direction:column; gap:8px; }
.gap-md { display:flex; flex-direction:column; gap:14px; }
.mt { margin-top:8px; }
.text-center { text-align:center; }
.hidden { display:none !important; }
.section-label { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
</style>
</head>
<body>
<div class="app">

<!-- HOME -->
<div id="screen-home" class="screen active">
  <div>
    <div class="eyebrow">Grammar Game</div>
    <div class="logo">Grammar<br><span>Impostor</span></div>
  </div>
  <p>One player gets no prompt and must bluff their way through. Everyone else writes a real example sentence. Can the group sniff out the Impostor?</p>
  <div class="gap-sm">
    <button class="btn btn-primary" onclick="showScreen('screen-create')">Create Room</button>
    <button class="btn btn-ghost"   onclick="showScreen('screen-join')">Join Room</button>
  </div>
  <p class="text-center" style="font-size:12px;"><a href="#" onclick="showScreen('screen-how')" style="color:var(--green);text-decoration:none;">How to play ‚Üí</a></p>
</div>

<!-- HOW TO PLAY -->
<div id="screen-how" class="screen">
  <div><div class="eyebrow">Rules</div><h2>How to Play</h2></div>
  <div class="gap-md">
    <div class="card"><div class="eyebrow" style="color:var(--green);margin-bottom:8px;">01 ‚Äî Roles</div><p><strong>Crewmates</strong> see the full grammar prompt. The <strong>Impostor</strong> sees nothing and must bluff.</p></div>
    <div class="card"><div class="eyebrow" style="color:var(--yellow);margin-bottom:8px;">02 ‚Äî Write</div><p>Everyone writes a sentence during the timer. Your sentence stays visible on your screen the whole time.</p></div>
    <div class="card"><div class="eyebrow" style="color:var(--blue);margin-bottom:8px;">03 ‚Äî Share</div><p>Read your sentence out loud, then tap <strong>"I'm Done Sharing"</strong>. Players can go in any order they choose.</p></div>
    <div class="card"><div class="eyebrow" style="color:var(--red);margin-bottom:8px;">04 ‚Äî Vote</div><p>After everyone shares, vote for who you think is the Impostor. Most votes = busted.</p></div>
    <div class="card"><div class="eyebrow" style="color:var(--yellow);margin-bottom:8px;">Points</div>
      <p>üé≠ Impostor survives = <strong style="color:var(--text)">+3</strong><br>üîç Correct vote on Impostor = <strong style="color:var(--text)">+2</strong><br>‚úÖ Crewmate survives vote = <strong style="color:var(--text)">+1</strong></p>
    </div>
  </div>
  <button class="btn btn-ghost" onclick="showScreen('screen-home')">‚Üê Back</button>
</div>

<!-- CREATE -->
<div id="screen-create" class="screen">
  <div><div class="eyebrow">Setup</div><h2>Create Room</h2></div>
  <div class="gap-sm"><label>Your Name</label><input type="text" id="create-name" placeholder="Your name" maxlength="20"></div>
  <div class="gap-sm">
    <label>Difficulty</label>
    <div class="row">
      <button class="btn btn-primary btn-sm diff-btn active" data-diff="easy"   onclick="selDiff(this)">Easy</button>
      <button class="btn btn-ghost   btn-sm diff-btn"        data-diff="medium" onclick="selDiff(this)">Medium</button>
      <button class="btn btn-ghost   btn-sm diff-btn"        data-diff="hard"   onclick="selDiff(this)">Hard</button>
      <button class="btn btn-ghost   btn-sm diff-btn"        data-diff="mixed"  onclick="selDiff(this)">Mixed</button>
    </div>
  </div>
  <div class="gap-sm">
    <label>Rounds</label>
    <div class="row">
      <button class="btn btn-primary btn-sm rounds-btn active" data-rounds="5"  onclick="selRounds(this)">5</button>
      <button class="btn btn-ghost   btn-sm rounds-btn"        data-rounds="8"  onclick="selRounds(this)">8</button>
      <button class="btn btn-ghost   btn-sm rounds-btn"        data-rounds="10" onclick="selRounds(this)">10</button>
    </div>
  </div>
  <div class="gap-sm">
    <label>Writing Timer</label>
    <div class="row">
      <button class="btn btn-ghost   btn-sm timer-btn"        data-secs="30"  onclick="selTimer(this)">30s</button>
      <button class="btn btn-primary btn-sm timer-btn active" data-secs="60"  onclick="selTimer(this)">60s</button>
      <button class="btn btn-ghost   btn-sm timer-btn"        data-secs="90"  onclick="selTimer(this)">90s</button>
      <button class="btn btn-ghost   btn-sm timer-btn"        data-secs="120" onclick="selTimer(this)">2min</button>
    </div>
  </div>
  <button class="btn btn-primary" onclick="createRoom()">Create Room ‚Üí</button>
  <button class="btn btn-ghost"   onclick="showScreen('screen-home')">‚Üê Back</button>
</div>

<!-- JOIN -->
<div id="screen-join" class="screen">
  <div><div class="eyebrow">Student</div><h2>Join Room</h2></div>
  <div class="gap-sm"><label>Your Name</label><input type="text" id="join-name" placeholder="Your name" maxlength="20"></div>
  <div class="gap-sm"><label>Room Code</label>
    <input type="text" id="join-code" placeholder="ABCD" maxlength="6"
      style="text-transform:uppercase;font-family:var(--font-display);font-size:2rem;letter-spacing:0.16em;text-align:center;">
  </div>
  <button class="btn btn-primary" onclick="joinRoom()">Join ‚Üí</button>
  <button class="btn btn-ghost"   onclick="showScreen('screen-home')">‚Üê Back</button>
</div>

<!-- LOBBY -->
<div id="screen-lobby" class="screen">
  <div><div class="eyebrow" id="lobby-eyebrow">Lobby</div><h2>Waiting for Players</h2></div>
  <div class="room-code-display">
    <div class="room-code-label">Room Code</div>
    <div class="room-code-big" id="lobby-code">----</div>
    <div id="qr-container"></div>
    <p style="font-size:11px;margin-top:10px;color:var(--muted);">Scan QR or enter code to join</p>
  </div>
  <div>
    <div class="section-label">
      <div class="eyebrow">Players</div>
      <div class="pill pill-green" id="lobby-count">0 players</div>
    </div>
    <div class="player-list" id="lobby-players"></div>
  </div>
  <button class="btn btn-primary" id="lobby-start-btn" onclick="startGame()" disabled>Start Game ‚Üí</button>
  <p class="text-center" style="font-size:12px;" id="lobby-hint">Need at least 3 players</p>
</div>

<!-- WRITE -->
<div id="screen-write" class="screen">
  <div><div class="eyebrow" id="write-round-label">Round 1 of 5</div><h2>Write Your Sentence</h2></div>
  <div id="write-prompt-box" class="prompt-box hidden">
    <div class="prompt-label">‚úÖ Your Prompt</div>
    <div class="prompt-text" id="write-prompt-text"></div>
  </div>
  <div id="write-imp-box" class="imp-box hidden">
    <div class="imp-label">üé≠ You are the Impostor</div>
    <div class="imp-text">No prompt for you. Listen when others share their sentences ‚Äî then craft something convincing.</div>
  </div>
  <div class="timer-ring">
    <svg class="timer-svg" width="140" height="140" viewBox="0 0 140 140">
      <circle class="timer-track" cx="70" cy="70" r="60"/>
      <circle class="timer-fill" id="timer-circle" cx="70" cy="70" r="60" stroke-dasharray="377" stroke-dashoffset="0"/>
    </svg>
    <div class="timer-number" id="timer-num">60</div>
    <div class="timer-label">seconds to write</div>
  </div>
  <div id="write-area" class="gap-sm">
    <label id="write-label">Your Sentence</label>
    <textarea id="write-input" placeholder="Compose your sentence here‚Ä¶"></textarea>
  </div>
  <div id="sentence-display-box" class="sentence-display hidden">
    <div class="sentence-display-label">Your sentence ‚Äî read this aloud when it's your turn</div>
    <div class="sentence-display-text" id="sentence-display-text"></div>
  </div>
  <button class="btn btn-danger hidden" id="end-timer-btn" onclick="hostEndTimer()">End Timer Early ‚Üí</button>
  <div id="write-done-msg" class="card green hidden">
    <p style="color:var(--green);">‚è± Time's up! Moving to sharing shortly‚Ä¶</p>
  </div>
</div>

<!-- SHARING -->
<div id="screen-sharing" class="screen">
  <div><div class="eyebrow" id="share-round-label">Round 1 of 5</div><h2>Share Your Sentences</h2></div>
  <div id="share-sentence-box" class="sentence-display hidden">
    <div class="sentence-display-label">Your sentence ‚Äî read this aloud</div>
    <div class="sentence-display-text" id="share-sentence-text"></div>
  </div>
  <div class="card yellow" style="font-size:14px;line-height:1.6;">
    üì¢ Read your sentence out loud, then tap <strong>I'm Done Sharing</strong>. Go in any order.
  </div>
  <div>
    <div class="section-label">
      <div class="eyebrow">Progress</div>
      <div class="pill pill-muted" id="share-progress">0 / 0</div>
    </div>
    <div class="ready-list" id="share-list"></div>
  </div>
  <button class="btn btn-ghost" id="done-sharing-btn" onclick="markDone()">‚úì I'm Done Sharing</button>
  <button class="btn btn-danger" id="go-vote-btn" onclick="goToVote()" style="display:none;">Everyone's Shared ‚Äî Vote ‚Üí</button>
</div>

<!-- VOTING -->
<div id="screen-voting" class="screen">
  <div><div class="eyebrow" id="vote-round-label">Round 1 of 5</div><h2>Who's the Impostor?</h2></div>
  <p>Tap the player you think is the Impostor. You can't vote for yourself.</p>
  <div id="voted-msg" class="card green hidden"><p style="color:var(--green);">‚úì Vote cast ‚Äî waiting for others‚Ä¶</p></div>
  <div class="vote-grid" id="vote-grid"></div>
  <div class="section-label mt">
    <div class="eyebrow">Votes in</div>
    <div class="pill pill-muted" id="vote-count-pill">0 / 0</div>
  </div>
  <div class="progress-bar"><div class="progress-fill" id="vote-bar" style="width:0%"></div></div>
</div>

<!-- RESULTS -->
<div id="screen-results" class="screen">
  <div id="result-hero" class="result-hero">
    <div class="result-emoji" id="result-emoji">üé≠</div>
    <div class="result-title" id="result-title"></div>
    <div class="result-sub"   id="result-sub"></div>
  </div>
  <div>
    <div class="eyebrow" style="margin-bottom:8px;">The Prompt Was</div>
    <div class="correct-box"><div class="correct-lbl">Grammar Task</div><div class="correct-text" id="result-prompt"></div></div>
  </div>
  <div>
    <div class="eyebrow" style="margin-bottom:8px;">Everyone's Sentences</div>
    <div id="result-answers"></div>
  </div>
  <div id="result-next-wrap"></div>
</div>

<!-- LEADERBOARD -->
<div id="screen-leaderboard" class="screen">
  <div><div class="eyebrow" id="lb-round-label">After Round 1</div><h2>Leaderboard</h2></div>
  <div id="lb-rows"></div>
  <div id="lb-next-wrap"></div>
  <div id="lb-wait" class="waiting hidden"><div class="spinner"></div><p>Waiting for host to start next round‚Ä¶</p></div>
</div>

<!-- FINAL -->
<div id="screen-final" class="screen">
  <div class="text-center">
    <div style="font-size:60px;margin-bottom:8px;">üèÜ</div>
    <div class="eyebrow" style="margin-bottom:4px;">Game Over</div>
    <h2 id="final-winner"></h2>
  </div>
  <div id="final-lb"></div>
  <button class="btn btn-ghost" onclick="location.reload()">Play Again</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, off }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDRnEiv8iRMLpXrVT2AihIXKB3bHo81sYc",
  authDomain: "grammar-imposter.firebaseapp.com",
  databaseURL: "https://grammar-imposter-default-rtdb.firebaseio.com",
  projectId: "grammar-imposter",
  storageBucket: "grammar-imposter.firebasestorage.app",
  messagingSenderId: "1030793331169",
  appId: "1:1030793331169:web:3239de9c849319a89f52a0"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const PROMPTS = {
  easy: [
    "Write a simple sentence.",
    "Write a compound sentence.",
    "Write a sentence with a direct object.",
    "Write a sentence with an indirect object.",
    "Write a sentence with an adjective.",
    "Write a sentence with an adverb.",
    "Write a sentence with the conjunction 'and'.",
    "Write a sentence with a preposition.",
    "Write a sentence with a pronoun.",
    "Write a sentence with the conjunction 'because'.",
    "Write a sentence where the subject is a proper noun.",
    "Write a sentence where the object is a collective noun.",
    "Write a sentence where the subject is an abstract noun.",
    "Write a sentence with an action verb.",
    "Write a sentence with a linking verb.",
  ],
  medium: [
    "Write a sentence with a participial phrase.",
    "Write a sentence with a gerund phrase.",
    "Write a sentence with a prepositional phrase.",
    "Write a sentence with an infinitive phrase.",
    "Write a complex sentence.",
    "Write a compound-complex sentence.",
    "Write a complex sentence using the subordinating conjunction 'because'.",
    "Write a sentence with a relative clause.",
    "Write a sentence where the GERUND is the SUBJECT.",
    "Write a sentence where the GERUND is the DIRECT OBJECT.",
    "Write a sentence where the GERUND is the INDIRECT OBJECT.",
    "Write a sentence where the object of the preposition is THE MALL.",
    "Write a sentence where the indirect object is MY FRIEND.",
    "Write a sentence where the object of the preposition is MY FRIEND.",
    "Write a sentence with an object complement (renames or describes a direct object).",
    "Write a sentence with a predicate nominative (follows a linking verb to rename the subject).",
    "Write a sentence with an intransitive verb.",

  ],
  hard: [
   "Write a sentence where an infinitive phrase is the SUBJECT.",
    "Write a sentence where an infinitive phrase is the DIRECT OBJECT.",
    "Write a sentence where an infinitive phrase is the PREDICATE NOMINATIVE.",
    "Write a sentence with an appositive phrase that renames the subject.",
    "Write a sentence where the GERUND is the PREDICATE NOMINATIVE.",
    "Write a sentence where the object of a preposition is a gerund phrase.",
    "Write a sentence where the object complement is MY DOG.",
    "Write a sentence where the predicate nominative is MY DOG.",
    "Write a sentence with a relative clause using the pronoun which.",
    "Write a sentence with a relative clause using the pronoun whom.",
    "Write a sentence with a relative clause using the pronoun that.",
    
  ],
  mixed: []
};
PROMPTS.mixed = [...PROMPTS.easy, ...PROMPTS.medium, ...PROMPTS.hard];

const AV = [
  {bg:'#ff3b5c',tx:'#fff'},{bg:'#00e5a0',tx:'#0a0a0e'},
  {bg:'#ffd166',tx:'#0a0a0e'},{bg:'#4ea8ff',tx:'#0a0a0e'},
  {bg:'#a78bfa',tx:'#fff'},{bg:'#fb923c',tx:'#fff'},
  {bg:'#f472b6',tx:'#fff'},{bg:'#34d399',tx:'#0a0a0e'},
];
function av(name, idx) {
  const c = AV[idx % AV.length];
  return `<div class="player-avatar" style="background:${c.bg};color:${c.tx}">${name[0].toUpperCase()}</div>`;
}

let myId='', myName='', roomCode='', gameRef='';
let isHost=false, difficulty='easy', totalRounds=5, timerSecs=60;
let timerInterval=null, timerTotal=60;
let myAnswer='';
let listeners=[];
let prevScores={};

window.showScreen = function(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
};

window.selDiff   = btn => selGroup('diff-btn',   btn, v=>difficulty=v,            'data-diff');
window.selRounds = btn => selGroup('rounds-btn', btn, v=>totalRounds=parseInt(v), 'data-rounds');
window.selTimer  = btn => selGroup('timer-btn',  btn, v=>timerSecs=parseInt(v),   'data-secs');
function selGroup(cls, btn, setter, attr) {
  document.querySelectorAll('.'+cls).forEach(b=>{b.classList.remove('active','btn-primary');b.classList.add('btn-ghost');});
  btn.classList.add('active','btn-primary'); btn.classList.remove('btn-ghost');
  setter(btn.getAttribute(attr));
}

function genCode() { return Array.from({length:4},()=>'ABCDEFGHJKLMNPQRSTUVWXYZ'[Math.floor(Math.random()*24)]).join(''); }
function genId()   { return Math.random().toString(36).slice(2,10); }
function watch(path, cb) { const r=ref(db,path); onValue(r,cb); listeners.push(r); }
function unwatch()       { listeners.forEach(r=>off(r)); listeners=[]; }

window.createRoom = async function() {
  const name = document.getElementById('create-name').value.trim();
  if (!name) { alert('Enter your name!'); return; }
  myName=name; myId=genId(); isHost=true;
  roomCode=genCode(); gameRef=`rooms/${roomCode}`;
  await set(ref(db,gameRef), {
    state:'lobby', host:myId, difficulty, totalRounds, timerSecs,
    currentRound:0, usedPrompts:[],
    players:{ [myId]:{ name, score:0, joinedAt:Date.now() } }
  });
  openLobby();
};

window.joinRoom = async function() {
  const name = document.getElementById('join-name').value.trim();
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (!name) { alert('Enter your name!'); return; }
  if (code.length < 3) { alert('Enter the room code!'); return; }
  myName=name; myId=genId(); isHost=false;
  roomCode=code; gameRef=`rooms/${roomCode}`;
  const snap = await get(ref(db,gameRef));
  if (!snap.exists()) { alert('Room not found ‚Äî check the code.'); return; }
  if (snap.val().state !== 'lobby') { alert('Game already in progress!'); return; }
  await update(ref(db,`${gameRef}/players/${myId}`), { name, score:0, joinedAt:Date.now() });
  openLobby();
};

function openLobby() {
  document.getElementById('lobby-code').textContent = roomCode;
  document.getElementById('lobby-eyebrow').textContent = isHost ? 'You are the Host' : 'Lobby';
  showScreen('screen-lobby');
  document.getElementById('qr-container').innerHTML = '';
  const url = `${location.origin}${location.pathname}?join=${roomCode}`;
  new QRCode(document.getElementById('qr-container'),{text:url,width:150,height:150,colorDark:'#0e0e12',colorLight:'#ffffff'});

  watch(`${gameRef}/players`, snap=>{
    const players=snap.val()||{};
    const entries=Object.entries(players).sort((a,b)=>a[1].joinedAt-b[1].joinedAt);
    document.getElementById('lobby-players').innerHTML=entries.map(([id,p],i)=>
      `<div class="player-item">${av(p.name,i)}<span class="player-name-text">${p.name}</span>${id===myId?'<span class="pill pill-green" style="font-size:10px;">You</span>':''}</div>`
    ).join('');
    document.getElementById('lobby-count').textContent=`${entries.length} player${entries.length!==1?'s':''}`;
    if (isHost) {
      document.getElementById('lobby-start-btn').disabled=entries.length<3;
      document.getElementById('lobby-hint').textContent=entries.length<3?'Need at least 3 players':'Ready ‚Äî tap Start!';
    } else {
      document.getElementById('lobby-start-btn').style.display='none';
      document.getElementById('lobby-hint').textContent='Waiting for host to start‚Ä¶';
    }
  });

  if (!isHost) watch(`${gameRef}/state`, snap=>{ if(snap.val()&&snap.val()!=='lobby') onStateChange(snap.val()); });
}

window.startGame = async function() { await beginRound(1); };

async function beginRound(round) {
  const snap=await get(ref(db,gameRef)); const game=snap.val();
  const playerIds=Object.keys(game.players);
  const pool=PROMPTS[game.difficulty]||PROMPTS.easy;
  const used=game.usedPrompts||[];
  let avail=pool.map((_,i)=>i).filter(i=>!used.includes(i));
  if(avail.length===0) avail=pool.map((_,i)=>i);
  const promptIdx=avail[Math.floor(Math.random()*avail.length)];
  const prompt=pool[promptIdx];
  const impostorId=playerIds[Math.floor(Math.random()*playerIds.length)];

  const updates={
    state:'write', currentRound:round, promptIdx, promptTask:prompt,
    impostorId, answers:{}, votes:{}, shared:{}, usedPrompts:[...used,promptIdx]
  };
  playerIds.forEach(id=>{ updates[`players/${id}/voted`]=false; });
  await update(ref(db,gameRef),updates);

  const fullSnap=await get(ref(db,gameRef));
  startWritePhase(fullSnap.val());
  watch(`${gameRef}/state`, snap=>{ if(snap.val()&&snap.val()!=='write') onStateChange(snap.val()); });
}

async function onStateChange(state) {
  const snap=await get(ref(db,gameRef)); const game=snap.val(); if(!game) return;
  if      (state==='write')       startWritePhase(game);
  else if (state==='sharing')     startSharingPhase(game);
  else if (state==='voting')      startVotingPhase(game);
  else if (state==='results')     showResults(game);
  else if (state==='leaderboard') showLeaderboard(game);
  else if (state==='final')       showFinal(game);
}

function startWritePhase(game) {
  myAnswer='';
  const amImp=game.impostorId===myId;
  document.getElementById('write-round-label').textContent=`Round ${game.currentRound} of ${game.totalRounds}`;
  document.getElementById('write-prompt-box').classList.toggle('hidden',amImp);
  document.getElementById('write-imp-box').classList.toggle('hidden',!amImp);
  if(!amImp) document.getElementById('write-prompt-text').textContent=game.promptTask;
  document.getElementById('write-input').value='';
  document.getElementById('write-area').classList.remove('hidden');
  document.getElementById('sentence-display-box').classList.add('hidden');
  document.getElementById('write-done-msg').classList.add('hidden');
  document.getElementById('write-label').textContent=amImp?'Your Bluff Sentence':'Your Sentence';
  document.getElementById('write-input').placeholder=amImp?'Write something that sounds like it fits‚Ä¶':'Write a sentence that fits the prompt‚Ä¶';
  document.getElementById('end-timer-btn').classList.toggle('hidden', !isHost);
  showScreen('screen-write');
    document.getElementById('write-input').oninput = function() {
    myAnswer = this.value; };
  runTimer(game.timerSecs||60, ()=>onTimerDone(game));
}

function runTimer(secs, onDone) {
  clearInterval(timerInterval);
  timerTotal=secs;
  let t=secs;
  const circ=377;
  const circle=document.getElementById('timer-circle');
  const numEl=document.getElementById('timer-num');
  function tick(){
    const frac=Math.max(0,t/timerTotal);
    circle.style.strokeDashoffset=circ*(1-frac);
    numEl.textContent=Math.max(0,t);
    if(t<=10){circle.style.stroke='var(--red)';numEl.style.color='var(--red)';}
    else if(t<=20){circle.style.stroke='var(--yellow)';numEl.style.color='var(--yellow)';}
    else{circle.style.stroke='var(--green)';numEl.style.color='var(--text)';}
    if(t<=0){clearInterval(timerInterval);onDone();return;}
    t--;
  }
  tick();
  timerInterval=setInterval(tick,1000);
}

window.hostEndTimer = async function() {
  clearInterval(timerInterval);
  document.getElementById('end-timer-btn').classList.add('hidden');
  const snap=await get(ref(db,gameRef));
  onTimerDone(snap.val());
};

function onTimerDone(game) {
  myAnswer=document.getElementById('write-input').value.trim()||'(no answer)';
  document.getElementById('write-area').classList.add('hidden');
  document.getElementById('sentence-display-box').classList.remove('hidden');
  document.getElementById('sentence-display-text').textContent=myAnswer;
  document.getElementById('write-done-msg').classList.remove('hidden');
  document.getElementById('end-timer-btn').classList.add('hidden');
  update(ref(db,`${gameRef}/answers/${myId}`),{text:myAnswer,name:myName});
  if(isHost){ setTimeout(async()=>{ await update(ref(db,gameRef),{state:'sharing'}); }, 2000); }
}

function startSharingPhase(game) {
  clearInterval(timerInterval);
  document.getElementById('share-round-label').textContent=`Round ${game.currentRound} of ${game.totalRounds}`;
  const sentBox=document.getElementById('share-sentence-box');
  if(myAnswer&&myAnswer!=='(no answer)'){
    sentBox.classList.remove('hidden');
    document.getElementById('share-sentence-text').textContent=myAnswer;
  } else { sentBox.classList.add('hidden'); }
  document.getElementById('done-sharing-btn').style.display='';
  document.getElementById('go-vote-btn').style.display='none';
  showScreen('screen-sharing');
  watchSharing(game);
}

function watchSharing(game) {
  const players=game.players||{};
  const total=Object.keys(players).length;
  watch(`${gameRef}/shared`, snap=>{
    const shared=snap.val()||{};
    const doneCount=Object.values(shared).filter(v=>v==='done').length;
    document.getElementById('share-progress').textContent=`${doneCount} / ${total}`;
    const entries=Object.entries(players).sort((a,b)=>a[1].joinedAt-b[1].joinedAt);
    document.getElementById('share-list').innerHTML=entries.map(([id,p],i)=>{
      const done=shared[id]==='done';
      return `<div class="ready-item ${done?'shared':''}">
        ${av(p.name,i)}
        <span class="ready-name">${p.name}${id===myId?' (you)':''}</span>
        ${done?'<span class="pill pill-green" style="font-size:10px;">Done ‚úì</span>':''}
      </div>`;
    }).join('');
    const myDone=shared[myId]==='done';
    document.getElementById('done-sharing-btn').style.display=myDone?'none':'';
    if(doneCount>=total){
      document.getElementById('done-sharing-btn').style.display='none';
      document.getElementById('go-vote-btn').style.display='';
    }
  });
}

window.markDone = async function() {
  await update(ref(db,`${gameRef}/shared`),{[myId]:'done'});
  document.getElementById('done-sharing-btn').style.display='none';
};

window.goToVote = async function() {
  unwatch();
  await update(ref(db,gameRef),{state:'voting'});
  const snap=await get(ref(db,gameRef)); startVotingPhase(snap.val());
  watch(`${gameRef}/state`, snap=>{ if(snap.val()) onStateChange(snap.val()); });
};

function startVotingPhase(game) {
  document.getElementById('vote-round-label').textContent=`Round ${game.currentRound} of ${game.totalRounds}`;
  const players=game.players||{};
  const entries=Object.entries(players).sort((a,b)=>a[1].joinedAt-b[1].joinedAt);
  const myVote=game.votes&&game.votes[myId];
  document.getElementById('voted-msg').classList.toggle('hidden',!myVote);
  document.getElementById('vote-grid').innerHTML=entries.map(([id,p],i)=>{
    const isSelf=id===myId; const isSelected=myVote===id;
    const vc=game.votes?Object.values(game.votes).filter(v=>v===id).length:0;
    return `<div class="vote-card ${isSelf?'no-vote':''} ${isSelected?'selected':''}" onclick="castVote('${id}')">
      ${av(p.name,i)}<span class="vote-name">${p.name}${isSelf?' (you)':''}</span>
      <span class="vote-badge ${vc>0?'show':''}">${vc}</span></div>`;
  }).join('');
  document.getElementById('vote-count-pill').textContent=`${Object.keys(game.votes||{}).length} / ${entries.length}`;
  document.getElementById('vote-bar').style.width=`${(Object.keys(game.votes||{}).length/entries.length)*100}%`;
  showScreen('screen-voting');
  watch(`${gameRef}/votes`, snap=>{
    const votes=snap.val()||{};
    const cast=Object.keys(votes).length; const total=entries.length;
    document.getElementById('vote-count-pill').textContent=`${cast} / ${total}`;
    document.getElementById('vote-bar').style.width=`${(cast/total)*100}%`;
    entries.forEach(([id])=>{
      const badge=document.querySelector(`.vote-card[onclick="castVote('${id}')"] .vote-badge`);
      if(badge){const c=Object.values(votes).filter(v=>v===id).length;badge.textContent=c;badge.classList.toggle('show',c>0);}
    });
    if(cast>=total){
      setTimeout(async()=>{
        const s=await get(ref(db,gameRef));
        if(s.val().state==='voting'){
          unwatch();
          await update(ref(db,gameRef),{state:'results'});
          showResults(s.val());
          watch(`${gameRef}/state`, snap=>{ if(snap.val()) onStateChange(snap.val()); });
        }
      },800);
    }
  });
}

window.castVote = async function(targetId) {
  const snap=await get(ref(db,gameRef));
  if(snap.val().votes&&snap.val().votes[myId]) return;
  if(targetId===myId) return;
  await update(ref(db,`${gameRef}/votes`),{[myId]:targetId});
  document.getElementById('voted-msg').classList.remove('hidden');
  document.querySelectorAll('.vote-card').forEach(c=>c.style.pointerEvents='none');
};

function showResults(game) {
  const players=game.players||{};
  const votes=game.votes||{};
  const answers=game.answers||{};
  const impId=game.impostorId; const imp=players[impId];
  const vc={};
  Object.values(votes).forEach(id=>{vc[id]=(vc[id]||0)+1;});
  const maxV=Math.max(0,...Object.values(vc));
  const topVoted=Object.entries(vc).filter(([,c])=>c===maxV).map(([id])=>id);
  const caught=topVoted.includes(impId)&&maxV>0;

  document.getElementById('result-emoji').textContent=caught?'üîç':'üé≠';
  document.getElementById('result-title').textContent=caught?'Impostor Found!':`${imp?.name} Escapes!`;
  document.getElementById('result-sub').innerHTML=caught
    ?`<strong>${imp?.name}</strong> was the Impostor. Crewmates win this round!`
    :`<strong>${imp?.name}</strong> bluffed successfully. Impostor wins!`;
  document.getElementById('result-hero').style.borderTop=`3px solid ${caught?'var(--green)':'var(--red)'}`;
  document.getElementById('result-prompt').textContent=game.promptTask;

  const entries=Object.entries(players).sort((a,b)=>a[1].joinedAt-b[1].joinedAt);
  document.getElementById('result-answers').innerHTML=entries.map(([id,p],i)=>{
    const isImp=id===impId; const ans=answers[id]?.text||'(no answer)'; const vcount=vc[id]||0;
    return `<div class="reveal-item ${isImp?'imp':''}">
      <div class="reveal-who ${isImp?'imp':''}">${isImp?'üé≠ IMPOSTOR ‚Äî ':''}${p.name}${vcount>0?` ¬∑ ${vcount} vote${vcount!==1?'s':''}`:''}</div>
      <div class="reveal-text">${ans}</div></div>`;
  }).join('');

  const pts={};
  Object.keys(players).forEach(id=>pts[id]=0);
  if(!caught) pts[impId]=(pts[impId]||0)+3;
  Object.entries(votes).forEach(([voter,target])=>{ if(target===impId) pts[voter]=(pts[voter]||0)+2; });
  entries.filter(([id])=>id!==impId).forEach(([id])=>{ if(!topVoted.includes(id)) pts[id]=(pts[id]||0)+1; });

  prevScores={};
  entries.forEach(([id,p])=>prevScores[id]=p.score||0);
  const scoreUpd={};
  entries.forEach(([id,p])=>{ scoreUpd[`players/${id}/score`]=(p.score||0)+(pts[id]||0); });
  update(ref(db,gameRef),scoreUpd);

  document.getElementById('result-next-wrap').innerHTML=isHost
    ?`<button class="btn btn-primary" onclick="goToLeaderboard()">See Leaderboard ‚Üí</button>`
    :`<div class="waiting"><div class="spinner"></div><p>Waiting for host‚Ä¶</p></div>`;

  showScreen('screen-results');
  if(!isHost) watch(`${gameRef}/state`, snap=>{ if(snap.val()) onStateChange(snap.val()); });
}

window.goToLeaderboard = async function() {
  unwatch();
  await update(ref(db,gameRef),{state:'leaderboard'});
  const snap=await get(ref(db,gameRef)); showLeaderboard(snap.val());
  watch(`${gameRef}/state`, snap=>{ if(snap.val()) onStateChange(snap.val()); });
};

function showLeaderboard(game) {
  const players=game.players||{};
  const round=game.currentRound; const total=game.totalRounds;
  const isLast=round>=total;
  document.getElementById('lb-round-label').textContent=`After Round ${round} of ${total}`;
  const sorted=Object.entries(players).sort((a,b)=>(b[1].score||0)-(a[1].score||0));
  const medals=['ü•á','ü•à','ü•â']; const rankCls=['first','second','third'];
  document.getElementById('lb-rows').innerHTML=sorted.map(([id,p],i)=>{
    const delta=(p.score||0)-(prevScores[id]||0);
    return `<div class="lb-row ${rankCls[i]||''}">
      <div class="lb-rank">${medals[i]||i+1+'.'}</div>
      ${av(p.name,i)}
      <div class="lb-name">${p.name}${id===myId?' <span style="font-size:11px;color:var(--muted)">(you)</span>':''}</div>
      <div><span class="lb-score">${p.score||0}</span>${delta>0?`<span class="lb-delta">+${delta}</span>`:''}</div>
    </div>`;
  }).join('');

  const wrap=document.getElementById('lb-next-wrap');
  const wait=document.getElementById('lb-wait');
  if(isHost){
    wait.classList.add('hidden');
    wrap.innerHTML=isLast
      ?`<button class="btn btn-primary" onclick="endGame()">See Final Results üèÜ</button>`
      :`<button class="btn btn-primary" onclick="nextRound()">Next Round ‚Üí</button>`;
  } else {
    wrap.innerHTML='';
    wait.classList.remove('hidden');
  }
  showScreen('screen-leaderboard');
}

window.nextRound = async function() {
  const snap=await get(ref(db,gameRef));
  const next=snap.val().currentRound+1;
  unwatch();
  await beginRound(next);
  watch(`${gameRef}/state`, snap=>{ if(snap.val()) onStateChange(snap.val()); });
};

window.endGame = async function() {
  unwatch();
  await update(ref(db,gameRef),{state:'final'});
  const snap=await get(ref(db,gameRef)); showFinal(snap.val());
};

function showFinal(game) {
  const players=game.players||{};
  const sorted=Object.entries(players).sort((a,b)=>(b[1].score||0)-(a[1].score||0));
  document.getElementById('final-winner').textContent=`${sorted[0][1].name} wins!`;
  const medals=['ü•á','ü•à','ü•â']; const rankCls=['first','second','third'];
  document.getElementById('final-lb').innerHTML=sorted.map(([id,p],i)=>
    `<div class="lb-row ${rankCls[i]||''}">
      <div class="lb-rank">${medals[i]||i+1+'.'}</div>
      ${av(p.name,i)}
      <div class="lb-name">${p.name}</div>
      <div class="lb-score">${p.score||0}</div>
    </div>`
  ).join('');
  showScreen('screen-final');
}

const urlP=new URLSearchParams(location.search);
if(urlP.get('join')){ document.getElementById('join-code').value=urlP.get('join').toUpperCase(); showScreen('screen-join'); }
</script>
</body>
</html>
